## Cơ chế xác thực dựa trên phiên (Session-based Authentication) trong Nextcloud

### Khái niệm cơ bản

Xác thực dựa trên phiên là một phương pháp xác thực người dùng trong đó người dùng đăng nhập một lần và sau đó được cấp một `phiên` (session) duy nhất để truy cập tài nguyên được bảo vệ trong một khoảng thời gian nhất định. Phiên này thường được lưu trữ trên máy chủ web và được xác định bởi một `ID phiên` (session ID) duy nhất được gán cho người dùng khi họ đăng nhập.

### Cơ chế hoạt động

1. **Đăng nhập:**
    * Người dùng nhập thông tin đăng nhập (tên người dùng, mật khẩu) vào form đăng nhập.
    * Server xác thực thông tin đăng nhập với cơ sở dữ liệu.
    * Nếu thông tin hợp lệ, server tạo một `ID phiên` duy nhất và lưu trữ thông tin phiên (ví dụ: ID người dùng, quyền truy cập) trong một cơ sở dữ liệu phiên (session storage) hoặc trong cookie của người dùng.
    * Server trả về một cookie chứa `ID phiên` cho người dùng.

2. **Truy cập tài nguyên được bảo vệ:**
    * Người dùng truy cập một tài nguyên được bảo vệ.
    * Browser gửi cookie chứa `ID phiên` cho server.
    * Server tìm kiếm thông tin phiên tương ứng với `ID phiên` trong cơ sở dữ liệu phiên.
    * Nếu tìm thấy thông tin phiên, server xác thực người dùng và cho phép họ truy cập tài nguyên.

3. **Kết thúc phiên:**
    * Người dùng thoát khỏi tài khoản hoặc phiên hết hạn.
    * Server xóa thông tin phiên khỏi cơ sở dữ liệu phiên.

### Mã nguồn Open Source Nextcloud

Trong Nextcloud, cơ chế xác thực dựa trên phiên được tích hợp trong `core/lib/Session/Session.php` và `core/lib/Session/SessionHandler.php`.

**1. Tạo ID phiên:**

```php
// core/lib/Session/Session.php
public function start(): void {
    if ($this->started) {
        return;
    }
    // ...
    $this->sessionHandler->start();
}
```

Phương thức `start()` trong lớp `Session` sẽ khởi tạo một `SessionHandler` và gọi phương thức `start()` của nó để tạo một `ID phiên` mới.

**2. Lưu trữ thông tin phiên:**

```php
// core/lib/Session/SessionHandler.php
public function start(): bool {
    // ...
    $this->id = session_id();
    // ...
    return true;
}
```

Phương thức `start()` trong lớp `SessionHandler` sẽ tạo một `ID phiên` mới bằng hàm `session_id()` và lưu trữ thông tin phiên vào cơ sở dữ liệu phiên.

**3. Xác thực phiên:**

```php
// core/lib/Session/Session.php
public function isLoggedIn(): bool {
    return $this->sessionHandler->isActive() && $this->user instanceof User;
}
```

Phương thức `isLoggedIn()` trong lớp `Session` sẽ kiểm tra xem phiên có hoạt động và người dùng đã đăng nhập hay chưa.

**4. Kết thúc phiên:**

```php
// core/lib/Session/Session.php
public function destroy(): void {
    if ($this->started) {
        $this->sessionHandler->destroy();
        $this->started = false;
        $this->user = null;
    }
}
```

Phương thức `destroy()` trong lớp `Session` sẽ gọi phương thức `destroy()` của `SessionHandler` để xóa thông tin phiên khỏi cơ sở dữ liệu phiên.

### Lưu ý

* Nextcloud sử dụng PHP `session` để quản lý phiên.
* Cơ sở dữ liệu phiên có thể là `file`, `memcache`, `redis` hoặc các loại lưu trữ khác.
* Quản trị viên Nextcloud có thể cấu hình thời gian hết hạn của phiên và các tùy chọn khác trong `config/config.php`.

### Kết luận

Xác thực dựa trên phiên là một phương pháp đơn giản và hiệu quả để xác thực người dùng trong Nextcloud. Nó cho phép người dùng truy cập tài nguyên được bảo vệ sau khi đăng nhập một lần và bảo vệ họ khỏi các cuộc tấn công giả mạo.
